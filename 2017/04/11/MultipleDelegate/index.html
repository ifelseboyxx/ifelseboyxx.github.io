<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Objective-C 之多重代理 · ifelseboyxx's Blog</title><meta name="description" content="Objective-C 之多重代理 - ifelseboyxx"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/user.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="ifelseboyxx's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/header.jpeg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/3224111110/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo&amp;is_all=1" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/ifelseboyxx" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://www.jianshu.com/u/c1fef1c0da1a" target="_blank" class="nav-list-link">JIANSHU</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Objective-C 之多重代理</h1><div class="post-info">Apr 11, 2017</div><div class="post-content"><p>在 Objective-C 中，经常使用 delegate 来实现对象之间通信，但是 delegate 一般是对象间一对一的通信，对于一对多的场景我们常用的是 KVO 以及通知中心。那么有些特殊的场景下，比如多个对象监听 UITableView 的滚动，这时候我们就需要思考如何实现 delegate 的一对多：</p>
<p><img src="/images/2.gif" alt=""></p>
<a id="more"></a>
<h2 id="动态方法决议与消息转发"><a href="#动态方法决议与消息转发" class="headerlink" title="动态方法决议与消息转发"></a>动态方法决议与消息转发</h2><p>在 Objective-C 中，如果向一个对象发送一条该对象无法处理的消息，会导致程序 crash：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//.h</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">XXViewOne</span> : <span class="title">UIView</span></span></div><div class="line">- (<span class="keyword">void</span>)xx;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">//.m</span></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">XXViewOne</span></span></div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>如果我们直接调用 <code>xx</code> 方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">XXViewOne *one = [XXViewOne new];</div><div class="line">[one xx];</div></pre></td></tr></table></figure>
<p>就会报如下错误：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">2017-04-11 19:24:15.826 MultipleDelegateDemo[8189:13619859] -[XXViewOne xx]: unrecognized selector sent to instance 0x7feaed404ee0</div><div class="line">2017-04-11 19:24:15.829 MultipleDelegateDemo[8189:13619859] *** Terminating app due to uncaught exception 'NSInvalidArgumentException', reason: '-[XXViewOne xx]: unrecognized selector sent to instance 0x7feaed404ee0'</div></pre></td></tr></table></figure>
<p>但是，在 crash 之前，oc 的运行时系统会先经过以下两个步骤：</p>
<ul>
<li>Dynamic Method Resolution</li>
<li>Message Forwarding</li>
</ul>
<h3 id="Dynamic-Method-Resolution（动态方法决议）"><a href="#Dynamic-Method-Resolution（动态方法决议）" class="headerlink" title="Dynamic Method Resolution（动态方法决议）"></a>Dynamic Method Resolution（动态方法决议）</h3><p>如果我们调用的是实例方法（-），会先调用下面的方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel &#123;</div><div class="line">    <span class="built_in">BOOL</span> hasSel = [<span class="keyword">super</span> resolveInstanceMethod:sel];</div><div class="line">    <span class="keyword">return</span> hasSel;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果我们调用的是静态方法（+），会先调用下面的方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">+ (<span class="built_in">BOOL</span>)resolveClassMethod:(SEL)sel &#123;</div><div class="line">    <span class="built_in">BOOL</span> hasSel = [<span class="keyword">super</span> resolveClassMethod:sel];</div><div class="line">    <span class="keyword">return</span> hasSel;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个我们就有机会在程序运行时，动态的为一个 SEL 提供实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel &#123;</div><div class="line">    <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(xx)) &#123;</div><div class="line">        class_addMethod(<span class="keyword">self</span>.class, sel, (IMP)DynamicMethodIMP, <span class="string">"v@:"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">BOOL</span> hasSel = [<span class="keyword">super</span> resolveInstanceMethod:sel];</div><div class="line">    <span class="keyword">return</span> hasSel;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> DynamicMethodIMP(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,<span class="built_in">NSStringFromSelector</span>(_cmd));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样，即使我们没有实现  <code>xx</code> 方法也不会 crash，因为我们已经在运行时动态的添加好了对应的实现。如果我们没有动态的添加实现并且 <code>resolveInstanceMethod:</code> 返回 <code>NO</code>，就会进入下一步消息转发（Message Forwarding）。</p>
<h3 id="Message-Forwarding（消息转发）"><a href="#Message-Forwarding（消息转发）" class="headerlink" title="Message Forwarding（消息转发）"></a>Message Forwarding（消息转发）</h3><p>首先会先调用下面的方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector &#123;</div><div class="line">    <span class="keyword">id</span> sel = [<span class="keyword">super</span> forwardingTargetForSelector:aSelector];</div><div class="line">    <span class="keyword">return</span> sel;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果这个方法中返回的不是 nil 或者 self，运行时系统将把消息发送给返回的那个对象。如果我们返回另一个实现 <code>xx</code> 方法的对象：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//XXViewOne.m</span></div><div class="line"></div><div class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector &#123;</div><div class="line">    XXViewTwo *twoObjc = [XXViewTwo new];</div><div class="line">    <span class="keyword">if</span> ([twoObjc respondsToSelector:aSelector]) &#123;</div><div class="line">        <span class="keyword">return</span> twoObjc;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> forwardingTargetForSelector:aSelector];</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//XXViewTwo.m</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">XXViewTwo</span></span></div><div class="line">- (<span class="keyword">void</span>)xx &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@ _ xx"</span>,<span class="keyword">self</span>.class);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>可以看到消息成功的转发到 <code>XXViewTwo</code> 对象中：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-11</span> <span class="number">20</span>:<span class="number">12</span>:<span class="number">31.526</span> MultipleDelegateDemo[<span class="number">8774</span>:<span class="number">13826022</span>] XXViewTwo _ xx</div></pre></td></tr></table></figure>
<p>如果返回 nil 或者 self，运行时系统会接着调用：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector &#123;</div><div class="line">    <span class="built_in">NSMethodSignature</span> *signature = [<span class="keyword">super</span> methodSignatureForSelector:aSelector];</div><div class="line">    <span class="keyword">return</span> signature;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的方法返回方法签名，方法签名记录了方法的参数和返回值的信息。这是最后一个寻找 IMP 的机会，如果返回 nil 就会抛出 <code>unrecognized selector sent to instance</code> 结束了；否则会接着调用下面的方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation &#123;&#125;</div></pre></td></tr></table></figure>
<p>相比于 <code>forwardingTargetForSelector:</code> 方法的只能以 selector 的形式转向一个对象，在这个函数里可以将 NSInvocation 多次转发到多个对象中，这就使得我们可以利用这个来实现 delegate 的一对多。</p>
<p>整个流程图如下：</p>
<p><img src="/images/multiple.png" alt=""></p>
<h2 id="实现多重代理"><a href="#实现多重代理" class="headerlink" title="实现多重代理"></a>实现多重代理</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//MultipleDelegateHelper.h</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MultipleDelegateHelper</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nonnull</span>) <span class="built_in">NSArray</span> *delegateTargets;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//MultipleDelegateHelper.m</span></div><div class="line"></div><div class="line"><span class="meta">#import <span class="meta-string">"MultipleDelegateHelper.h"</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MultipleDelegateHelper</span> ()</span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nonnull</span>) <span class="built_in">NSPointerArray</span> *weakTargets;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MultipleDelegateHelper</span></span></div><div class="line"></div><div class="line">- (<span class="built_in">NSPointerArray</span> *)weakTargets &#123;</div><div class="line">    <span class="keyword">if</span> (!_weakTargets) &#123;</div><div class="line">        _weakTargets = [<span class="built_in">NSPointerArray</span> weakObjectsPointerArray];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> _weakTargets;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setDelegateTargets:(<span class="built_in">NSArray</span> *)delegateTargets&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">id</span> delegate <span class="keyword">in</span> delegateTargets) &#123;</div><div class="line">        [<span class="keyword">self</span>.weakTargets addPointer:(__bridge <span class="keyword">void</span> * _Nullable)(delegate)];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)respondsToSelector:(SEL)aSelector&#123;</div><div class="line">    <span class="keyword">if</span> ([<span class="keyword">super</span> respondsToSelector:aSelector]) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">id</span> target <span class="keyword">in</span> <span class="keyword">self</span>.weakTargets) &#123;</div><div class="line">        <span class="keyword">if</span> ([target respondsToSelector:aSelector]) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector&#123;</div><div class="line">    <span class="built_in">NSMethodSignature</span> *sig = [<span class="keyword">super</span> methodSignatureForSelector:aSelector];</div><div class="line">    <span class="keyword">if</span> (!sig) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> target <span class="keyword">in</span> <span class="keyword">self</span>.weakTargets) &#123;</div><div class="line">            <span class="keyword">if</span> ((sig = [target methodSignatureForSelector:aSelector])) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> sig;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">id</span> target <span class="keyword">in</span> <span class="keyword">self</span>.weakTargets) &#123;</div><div class="line">        <span class="keyword">if</span> ([target respondsToSelector:anInvocation.selector]) &#123;</div><div class="line">            [anInvocation invokeWithTarget:target];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>因为 NSArray 会对对象进行 retain 操作，导致循环引用的产生，所以我们可以用 NSPointerArray 来解决这个问题，但是对象也需要强引用 <code>MultipleDelegateHelper</code> 对象。</p>
<h4 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h4><p><a href="https://github.com/ifelseboyxx/xx_Notes" target="_blank" rel="external">MultipleDelegateDemo</a></p>
<h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><p><a href="http://www.cnblogs.com/biosli/p/NSObject_inherit_2.html" target="_blank" rel="external">继承自NSObject的不常用又很有用的函数（2）
</a></p>
<p><a href="http://zziking.github.io/2015/11/01/%E5%88%A9%E7%94%A8OC%E7%9A%84%E5%8A%A8%E6%80%81%E6%96%B9%E6%B3%95%E5%86%B3%E8%AE%AE%E4%B8%8E%E6%B6%88%E6%81%AF%E8%BD%AC%E5%8F%91%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0%E5%A4%9A%E9%87%8D%E4%BB%A3%E7%90%86.html" target="_blank" rel="external">利用OC的动态方法决议与消息转发机制实现多重代理</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/04/17/protocol/" class="prev">PREV</a><a href="/2017/03/19/AsynDrawText/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2017 <a href="http://blog.ifelseboyxx.com/">ifelseboyxx</a> | Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>
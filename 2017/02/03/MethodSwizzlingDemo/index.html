<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Method Swizzling 实战：优雅的延迟按钮回调 · ifelseboyxx's Blog</title><meta name="description" content="Method Swizzling 实战：优雅的延迟按钮回调 - ifelseboyxx"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/user.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="ifelseboyxx's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/header.jpeg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/3224111110/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo&amp;is_all=1" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/ifelseboyxx" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://www.jianshu.com/u/c1fef1c0da1a" target="_blank" class="nav-list-link">JIANSHU</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Method Swizzling 实战：优雅的延迟按钮回调</h1><div class="post-info">2017年2月3日</div><div class="post-content"><p>话不多说，我们先来看下效果：</p>
<p><img src="/images/021.gif" alt=""></p>
<p>我们可以发现按钮的用法和系统一样，只是多设置了个<code>xx_delayTime</code>为<code>2.0f秒</code>，下面的打印时间间隔也是对的，优雅！<br><a id="more"></a><br>在我们看下去之前先抛个问题：</p>
<blockquote>
<p><strong>是谁包装 UIButton 的点击事件消息，并完成发送消息？</strong></p>
</blockquote>
<p>搞懂这个问题很关键，如果我们知道了具体包装事件消息的地方以及发送按钮点击事件的时机，那么我们就可以拦截它，决定它是在我们想要的时间返回内发送消息还是继续发送信息。</p>
<p><code>UIButton</code>继承自<code>UIControl</code>，我们很容易就可以在<code>UIControl</code>头文件中找到下面的方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// send the action. the first method is called for the event and is a point at which you can observe or override behavior. it is called repeately by the second.</span></div><div class="line">- (<span class="keyword">void</span>)sendAction:(SEL)action to:(<span class="keyword">nullable</span> <span class="keyword">id</span>)target forEvent:(<span class="keyword">nullable</span> <span class="built_in">UIEvent</span> *)event;</div></pre></td></tr></table></figure>
<p>我们直接上代码看看调用顺序：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TestButton</span></span></div><div class="line">- (<span class="keyword">void</span>)sendAction:(SEL)action to:(<span class="keyword">id</span>)target forEvent:(<span class="built_in">UIEvent</span> *)event &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"log1"</span>);</div><div class="line">    [<span class="keyword">super</span> sendAction:action to:target forEvent:event];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"log2"</span>);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>调用：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setUpButton &#123;</div><div class="line">    [<span class="keyword">self</span>.view addSubview:^&#123;</div><div class="line">        TestButton *btn = [TestButton buttonWithType:<span class="built_in">UIButtonTypeCustom</span>];</div><div class="line">        btn.backgroundColor = [<span class="built_in">UIColor</span> blackColor];</div><div class="line">        btn.frame = <span class="built_in">CGRectMake</span>(<span class="number">50.0</span>f, <span class="number">100.0</span>f, <span class="number">150.0</span>f, <span class="number">50.0</span>f);</div><div class="line">        [btn addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(btnClick) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</div><div class="line">        <span class="keyword">return</span> btn;</div><div class="line">    &#125;()];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)btnClick &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"BtnDidClick"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：</p>
<p><img src="/images/022.png" alt=""></p>
<p>果不其然：<code>sendAction:to:forEvent:</code>调用优先级较高，它包装了按钮的点击事件消息并完成消息发送！</p>
<p>知道调用顺序就好办了，我们利用 <code>Method Swizzling</code> hook 住<code>sendAction:to:forEvent:</code>做一些事情就行了：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//.h</span></div><div class="line"></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UIControl</span> (<span class="title">DelayEvent</span>)</span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSTimeInterval</span> xx_delayTime;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//.m</span></div><div class="line"></div><div class="line"><span class="meta">#import <span class="meta-string">"UIControl+DelayEvent.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIControl</span> (<span class="title">DelayEvent</span>)</span></div><div class="line"></div><div class="line">- (<span class="built_in">NSTimeInterval</span>)xx_delayTime &#123;</div><div class="line">    <span class="keyword">return</span> [objc_getAssociatedObject(<span class="keyword">self</span>, _cmd) doubleValue];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setXx_delayTime:(<span class="built_in">NSTimeInterval</span>)xx_delayTime &#123;</div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>,</div><div class="line">                             <span class="keyword">@selector</span>(xx_delayTime),</div><div class="line">                             @(xx_delayTime),</div><div class="line">                             OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)xx_ignoreEvent &#123;</div><div class="line">    <span class="keyword">return</span> [objc_getAssociatedObject(<span class="keyword">self</span>, _cmd) boolValue];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setXx_ignoreEvent:(<span class="built_in">BOOL</span>)xx_ignoreEvent &#123;</div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>,</div><div class="line">                             <span class="keyword">@selector</span>(xx_ignoreEvent),</div><div class="line">                             @(xx_ignoreEvent),</div><div class="line">                             OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="keyword">void</span>)load &#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line">        SEL mySEL = <span class="keyword">@selector</span>(xx_sendAction:to:forEvent:);</div><div class="line">        SEL systemSEL = <span class="keyword">@selector</span>(sendAction:to:forEvent:);</div><div class="line">        Class <span class="keyword">class</span> = [<span class="keyword">self</span> <span class="keyword">class</span>];</div><div class="line">        Method myM = class_getInstanceMethod(<span class="keyword">class</span>, mySEL);</div><div class="line">        Method systemM = class_getInstanceMethod(<span class="keyword">class</span>, systemSEL);</div><div class="line">        <span class="built_in">BOOL</span> success = class_addMethod(<span class="keyword">class</span>,</div><div class="line">                                       mySEL,</div><div class="line">                                       method_getImplementation(systemM),</div><div class="line">                                       method_getTypeEncoding(systemM));</div><div class="line">        <span class="keyword">if</span> (success) &#123;</div><div class="line">            class_replaceMethod(<span class="keyword">class</span>,</div><div class="line">                                systemSEL,</div><div class="line">                                method_getImplementation(myM),</div><div class="line">                                method_getTypeEncoding(myM));</div><div class="line">        &#125;<span class="keyword">else</span> &#123;</div><div class="line">            method_exchangeImplementations(myM, systemM);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)xx_sendAction:(SEL)action to:(<span class="keyword">id</span>)target forEvent:(<span class="built_in">UIEvent</span> *)event &#123;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.xx_ignoreEvent) <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.xx_delayTime &gt; <span class="number">0.0</span>f) &#123;</div><div class="line">        <span class="keyword">self</span>.xx_ignoreEvent = <span class="literal">YES</span>;</div><div class="line">        [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(setXx_ignoreEvent:)</div><div class="line">                   withObject:@(<span class="literal">NO</span>)</div><div class="line">                   afterDelay:<span class="keyword">self</span>.xx_delayTime];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span> xx_sendAction:action to:target forEvent:event];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<blockquote>
<p>我这里在<code>UIControl+DelayEvent.h</code>分类里重写了<code>sendAction:to:forEvent:</code>方法，定义了<code>xx_ignoreEvent</code>这个<code>Bool</code>变量，并根据是否需要延迟也就是<code>xx_delayTime</code>变量的值，来决定是否需要通过<code>performSelector:withObject:afterDelay:</code>来延迟调用。</p>
</blockquote>
<p>上面这段代码还牵扯到<code>Runtime</code>两个知识点：</p>
<ul>
<li><strong>Method Swizzling</strong></li>
<li><strong>Associated Objects</strong></li>
</ul>
<p>关于<code>Method Swizzling</code>可以看看我之前的一篇 blog：<a href="http://blog.ifelseboyxx.com/2017/01/25/Method-Swizzling/" target="_blank" rel="external">浅谈 Method Swizzling</a></p>
<p>关于<code>Associated Objects</code>可以看看 <a href="http://blog.leichunfeng.com/" target="_blank" rel="external">雷神</a> 的这篇 blog：<a href="http://blog.leichunfeng.com/blog/2015/06/26/objective-c-associated-objects-implementation-principle/" target="_blank" rel="external">Objective-C Associated Objects 的实现原理</a></p>
<p>最后说个我困惑很久答案却让我莞尔一笑的问题：</p>
<blockquote>
<p>Associated Objects 的 <code>key 值</code> <strong>为什么在<code>getter</code>方法里面用<code>_cmd</code>，而在<code>setter</code>方法里面却用<code>@selector(xxx)</code>，为什么不都用<code>_cmd</code>？</strong></p>
</blockquote>
<p><code>_cmd</code>表示当前方法的 <code>selector</code>，正如同<code>self</code>表示当前方法调用的对象实例一样。在 Associated Objects 中，<strong>绑定同一个属性<code>setter</code>和<code>getter</code>肯定用的是同一个<code>key值</code>！</strong></p>
<p>我们来打印看看就明白了：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSTimeInterval</span>)xx_delayTime &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"getter “_cmd”     -&gt; %@"</span>,<span class="built_in">NSStringFromSelector</span>(_cmd));</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"getter “selector” -&gt; %@"</span>,<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(xx_delayTime)));</div><div class="line">    <span class="keyword">return</span> [objc_getAssociatedObject(<span class="keyword">self</span>, _cmd) doubleValue];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setXx_delayTime:(<span class="built_in">NSTimeInterval</span>)xx_delayTime &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"setter “_cmd”     -&gt; %@"</span>,<span class="built_in">NSStringFromSelector</span>(_cmd));</div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>,</div><div class="line">                             <span class="keyword">@selector</span>(xx_delayTime),</div><div class="line">                             @(xx_delayTime),</div><div class="line">                             OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="number">2017</span><span class="number">-02</span><span class="number">-03</span> <span class="number">21</span>:<span class="number">56</span>:<span class="number">07.366</span> DelayButtonDemo[<span class="number">980</span>:<span class="number">43300</span>] <span class="keyword">setter</span> “_cmd”     -&gt; setXx_delayTime:</div><div class="line"><span class="number">2017</span><span class="number">-02</span><span class="number">-03</span> <span class="number">21</span>:<span class="number">56</span>:<span class="number">21.193</span> DelayButtonDemo[<span class="number">980</span>:<span class="number">43300</span>] <span class="keyword">getter</span> “_cmd”     -&gt; xx_delayTime</div><div class="line"><span class="number">2017</span><span class="number">-02</span><span class="number">-03</span> <span class="number">21</span>:<span class="number">56</span>:<span class="number">21.194</span> DelayButtonDemo[<span class="number">980</span>:<span class="number">43300</span>] <span class="keyword">getter</span> “selector” -&gt; xx_delayTime</div></pre></td></tr></table></figure>
<blockquote>
<p><code>setter</code>里面如果用<code>_cmd</code>打印出来是<code>setXx_delayTime:</code>，这样上面的问题也就迎刃而解了!</p>
</blockquote>
<p>最后附上 <a href="https://github.com/ifelseboyxx/DelayButtonDemo" target="_blank" rel="external">Demo</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/02/23/Masonry-Analysis/" class="prev">上一篇</a><a href="/2017/01/25/Method-Swizzling/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2017 <a href="http://blog.ifelseboyxx.com/">ifelseboyxx</a> | Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>